#!/usr/bin/env node
var route, routeName, domain, parts, path, 
	query, engine, debug, argv, cmd, root;

path = require('path');
debug = require('debug');

// enable Worker messages
debug.enable('Worker');
debug.enable('Agent*');

argv = process.argv;

if ( argv.length > 5 || argv.length < 3 ) {
	displayUsage();
	process.exit(0);
}

root = path.normalize( path.join(__dirname, '..') );
engine = require(root+'/lib/engine');
cmd = argv[2];


switch (cmd) {

	case 'scrape':

		if ( argv.length === 3 ) {
			console.log('Please, specify the domain and route to scrape.');
			process.exit(0);
		}

		// load the route (or init script)
		parts = argv[3].split(':');
		domain = parts[0];
		routeName = parts[1] ? parts[1] : 'init';
		query = argv[4] ? argv[4] : undefined;

		try {
			route = require(root+'/routes/'+domain+'/'+routeName);

		} catch(err) {
			if ( err.code === 'MODULE_NOT_FOUND' ) {

				console.error( routeName === 'init' ? 
					'No init script for '+domain+'.' :
					'Route '+argv[3]+' not found.');

				process.exit(1);

			} else {
				throw err;
			}
		}

		// start the route. init scripts may not export a route to start.
		route.start(query);

		break;

	case 'work':
		engine.start();
		break;

	default:
		console.log('Unknown command '+cmd);
		displayUsage();
		process.exit(0);
}

function displayUsage() {
	console.log(
		'Usage: nest [scrape | work] [[domain:route] | [domain]] ([query])\n'+
		'ej. nest scrape imdb');
}
